<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../">
  <title data-ice="title">src/json/compile.js | @dikotech/basic</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  <script src="script/manual.js"></script>
<meta name="description" content="Basic Javascript helpers"><meta property="twitter:card" content="summary"><meta property="twitter:title" content="@dikotech/basic"><meta property="twitter:description" content="Basic Javascript helpers"></head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
<a style="position:relative; top:3px;" href="https://github.com/diko316/dikotech-basic"><img width="20px" src="./image/github.png"></a></header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#array">array</a><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-listPadEnd">listPadEnd</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-listPadStart">listPadStart</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-Iteratable">Iteratable</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-IteratableObject">IteratableObject</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#lifecycle">lifecycle</a><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-destructor">destructor</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#native">native</a><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-array">array</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-bigint">bigint</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-boolean">boolean</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-date">date</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-iteratable">iteratable</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-method">method</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-number">number</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-numeric">numeric</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-object">object</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-promise">promise</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-regexp">regexp</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-scalar">scalar</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-signature">signature</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-string">string</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-symbol">symbol</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#number">number</a><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-numberify">numberify</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#object">object</a><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-assign">assign</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-each">each</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-contains">contains</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#string">string</a><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-padEnd">padEnd</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-padStart">padStart</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-repeat">repeat</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-trim">trim</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-trimEnd">trimEnd</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-trimStart">trimStart</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-stringify">stringify</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#unicode">unicode</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/unicode/Utf.js~Utf.html">Utf</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-codepoints2Utf">codepoints2Utf</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-unicodeCount">unicodeCount</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-unicodify">unicodify</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-codePoint2string">codePoint2string</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-eachUnicode">eachUnicode</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-string2codePoints">string2codePoints</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-string2unicodes">string2unicodes</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">src/json/compile.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">// import { FUNCTION } from &quot;../native/function&quot;;

import { parse } from &quot;./parser&quot;;

// import { reportCompileError } from &quot;./error-reporting&quot;;

// import {
//   preprocess,
//   postprocess
// } from &quot;./compile/initialize&quot;;

import {
  operand
} from &quot;./compile/operand&quot;;

import {
  objectAccess
} from &quot;./compile/object-access&quot;;

import {
  arithmetic
} from &quot;./compile/arithmetic&quot;;

import {
  condition
} from &quot;./compile/condition&quot;;

// import {
//   get
// } from &quot;./compile/query&quot;;

export function show(rpn) {
  const output = [];

  rpn.forEach(
    (item, index) =&gt; {
      output[index] = item.value;
    }
  );

  console.log(&quot;rpn: &quot;, output.join(&quot; &quot;));
}

export function compile(subject) {
  const rpn = parse(subject);
  // const report = reportCompileError;
  const symbols = [];
  const stack = [];
  const features = {
    symbols: true,
    finite: false,
    signature: false,
    objectHasOwn: false,
    objectPrototype: false
  };

  let slength = 0;
  let rlength = 0;
  let rc = 0;
  let lexeme = null;
  let operands = null;

  if (!rpn) {
    return null;
  }

  show(rpn);

  for (rlength = rpn.length; rlength--; rc++) {
    lexeme = rpn[rc];
    symbols[symbols.length] = lexeme.symbol;

    // operands
    if (lexeme.type === &quot;operand&quot;) {
      lexeme.augmented = false;
      operand(lexeme, symbols);
      stack[slength++] = lexeme;
      continue;
    }

    lexeme.augmented = true;

    // resolve operands
    operands = lexeme.operands;
    if (operands) {
      slength -= operands;
      operands = stack.slice(slength, slength + operands);
    }
    else {
      operands = [];
    }

    switch (lexeme.rule) {
    // arithmetic
    case &quot;add&quot;:
    case &quot;sub&quot;:
    case &quot;mul&quot;:
    case &quot;div&quot;:
    case &quot;mod&quot;:
      features.finite = true;
      arithmetic(
        lexeme,
        symbols,
        operands
      );
      break;

    // condition
    case &quot;eq&quot;:
    case &quot;neq&quot;:
    case &quot;gt&quot;:
    case &quot;gte&quot;:
    case &quot;lt&quot;:
    case &quot;lte&quot;:
    case &quot;pattern&quot;:
      condition(lexeme, operands[0], operands[1]);
      features.signature = true;
      break;

    // object
    case &quot;access&quot;:
      objectAccess(lexeme, operands[0], operands[1]);
    }

    stack[slength++] = lexeme;
  }
}

// export function compile(subject) {
//   const rpn = parse(subject);
//   const report = reportCompileError;
//   const code = [];
//   const symbols = [];
//   const stack = [];
//   const features = {
//     symbols: true,
//     finite: false,
//     signature: false,
//     objectHasOwn: false,
//     objectPrototype: false
//   };
//   let stackLength = 0;
//   let node = 0;
//   let nodeId = null;
//   let operands = null;

//   // dont if no rpn created
//   if (!rpn) {
//     return null;
//   }

//   const output = [];
//   rpn.forEach(
//     (item, index) =&gt; {
//       output[index] = item.value;
//     }
//   );

//   console.log(&quot;rpn: &quot;, output.join(&quot; &quot;));
//   console.log(rpn);

//   preprocess(code);

//   // generate source code
//   for (let c = 0, length = rpn.length; length--; c++) {
//     node = rpn[c];

//     // operands
//     if (node.type === &quot;operand&quot;) {
//       node.augmented = false;
//       operand(node, code, symbols);
//       stack[stackLength++] = node;
//       continue;
//     }

//     operands = node.operands;

//     if (stackLength &lt; operands) {
//       report(
//         `Low on operands ${node.value}`,
//         node
//       );
//       console.log(
//         code.join(&quot;\r\n&quot;)
//       );
//       return null;
//     }
//     node.augmented = true;
//     nodeId = node.id;
//     stackLength -= operands;
//     operands = stack.slice(stackLength, stackLength + operands);
//     node.arguments = operands;

//     switch (nodeId) {
//     case &quot;get&quot;:
//       get(features, node, code, symbols);
//       break;

//     case &quot;add&quot;:
//     case &quot;sub&quot;:
//     case &quot;mul&quot;:
//     case &quot;div&quot;:
//     case &quot;mod&quot;:
//       arithmetic(features, node, code, symbols);
//       stack[stackLength++] = node;
//       break;

//     case &quot;eq&quot;:
//     case &quot;neq&quot;:
//     case &quot;gt&quot;:
//     case &quot;gte&quot;:
//     case &quot;lt&quot;:
//     case &quot;lte&quot;:
//     case &quot;pattern&quot;:
//       condition(features, node, code);
//       stack[stackLength++] = node;
//       break;

//     case &quot;access&quot;:
//       access(features, node, code, symbols);
//       stack[stackLength++] = node;
//       break;

//     case &quot;list&quot;:
//       break;

//     default:
//       console.log(&quot;unprocessed &quot;, node);
//     }

//     // console.log(
//     //   &quot;id&quot;, nodeId,
//     //   &quot;operands&quot;, operands,
//     //   &quot;stack&quot;, stack.slice(0, stackLength)
//     // );
//   }

//   postprocess(
//     code,
//     symbols,
//     features
//   );

//   try {
//     const compiled = new FUNCTION(&quot;root&quot;, code.join(&quot;\n&quot;));
//     compiled({});
//     console.log(
//       compiled.toString()
//     );
//   }
//   catch (error) {
//     console.log(code.join(&quot;\n&quot;));
//     throw error;
//   }
// }
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(1.1.0)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
