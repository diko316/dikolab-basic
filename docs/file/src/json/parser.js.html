<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../">
  <title data-ice="title">src/json/parser.js | @dikotech/basic</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  <script src="script/manual.js"></script>
<meta name="description" content="Basic Javascript helpers"><meta property="twitter:card" content="summary"><meta property="twitter:title" content="@dikotech/basic"><meta property="twitter:description" content="Basic Javascript helpers"></head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
<a style="position:relative; top:3px;" href="https://github.com/diko316/dikotech-basic"><img width="20px" src="./image/github.png"></a></header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#array">array</a><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-listPadEnd">listPadEnd</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-listPadStart">listPadStart</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-Iteratable">Iteratable</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-IteratableObject">IteratableObject</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#lifecycle">lifecycle</a><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-destructor">destructor</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#native">native</a><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-array">array</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-bigint">bigint</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-boolean">boolean</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-date">date</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-iteratable">iteratable</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-method">method</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-number">number</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-numeric">numeric</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-object">object</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-promise">promise</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-regexp">regexp</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-scalar">scalar</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-signature">signature</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-string">string</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-symbol">symbol</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#number">number</a><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-numberify">numberify</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#object">object</a><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-assign">assign</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-each">each</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-contains">contains</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#string">string</a><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-padEnd">padEnd</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-padStart">padStart</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-repeat">repeat</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-trim">trim</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-trimEnd">trimEnd</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-trimStart">trimStart</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-stringify">stringify</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#unicode">unicode</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/unicode/Utf.js~Utf.html">Utf</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-codepoints2Utf">codepoints2Utf</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-unicodeCount">unicodeCount</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-unicodify">unicodify</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-codePoint2string">codePoint2string</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-eachUnicode">eachUnicode</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-string2codePoints">string2codePoints</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-string2unicodes">string2unicodes</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">src/json/parser.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">import MANIFEST from &quot;./parser-reference.json&quot;;

import {
  INVALID_OPERAND_TOKEN,
  INVALID_SEPARATOR_TOKEN
} from &quot;./constants&quot;;

import { tokenize } from &quot;./tokenizer&quot;;

import { reportParseError } from &quot;./error-reporting&quot;;

export function parse(subject) {
  const manifest = MANIFEST;
  const reference = manifest.reference;
  const report = reportParseError;
  const rpn = [];

  let index = 0;
  let rpnLength = 0;
  let operands = 0;
  let isExpectingOperand = true;
  let line = 1;
  let stack = null;
  let stackNode = null;
  let isSeparator;
  let isOperand;
  let separator;
  let isMultiArguments;
  let isEnder;
  let stackPop;
  let stackPush;
  let stackOutput;
  let value;
  let from;
  let to;
  let token;
  let node;
  let definition;
  let item;
  let precedence;
  let expectedOperands;
  let max;

  /* eslint no-labels: 0 */
  loop: for (token = tokenize(subject, index); token; token = tokenize(subject, index)) {
    value = token[1];
    from = index;
    index = to = token[2];
    line += token[3];
    token = token[0];
    definition = reference[token];

    isSeparator =
      isMultiArguments = false;

    // preprocess
    switch (definition[0]) {
    case 0: continue loop;
    case 4: // multi arguments
      isMultiArguments = true;
      break;

    case 5: // separator
      isSeparator = true;
      break;

    case 3:
      definition = isExpectingOperand
        ? definition[1]
        : definition[2];
      break;
    }

    // node
    node = {
      rule: definition[1],
      token,
      value,
      operands: 0,
      requiredLeftOperands: 0,
      min: 0,
      max: 0,
      literal: false,
      augmented: true,
      from,
      to,
      line
    };

    stackPop =
      stackPush =
      isOperand =
      stackOutput = false;

    switch (definition[0]) {
    case 11: // literal number/string/regex
      node.literal = true;

    // falls through
    case 10: // operand
      isOperand = true;
      break;

    case 1: // infix unary
    case 2: // binary
    case 4: // multi arguments
    case 5: // separator
      node.requiredLeftOperands = definition[3];

      if (isMultiArguments) {
        node.separator = definition[7];
      }

      // separator only
      if (isSeparator) {
        stackNode = null;
        for (item = stack; item; item = item[0]) {
          stackNode = item[1];
          if (stackNode.separator) {
            node.precedence = stackNode.precedence + 1;
            break;
          }
          if (stackNode.ender) {
            break;
          }
        }
        node.requiredLeftOperands = 1;
        node.min = node.max = 2;
        node.isSeparator = true;
        if (!stackNode || stackNode.separator !== node.token) {
          report(INVALID_SEPARATOR_TOKEN, node, subject);
          return null;
        }
      }
      else {
        node.min = definition[4];
        node.max = definition[5];
        node.precedence = definition[6];
      }

      isExpectingOperand =
        stackPop =
        stackPush = true;
      break;

    case 15: // enclosure
      node.requiredLeftOperands = definition[3];
      node.precedence = precedence = definition[6];
      node.ender = definition[7];
      node.separator = definition[8];

      if (precedence) {
        stackPop = true;
      }

      if (separator) {
        node.separator = separator;
      }

      stackPush =
        isExpectingOperand = true;
      break;

    case 16: // ender
      isExpectingOperand = false;
      stackOutput = true;

    // falls through
    case 20: // end
      node.precedence = 0;
      stackOutput = true;
      break;
    }

    if (isOperand) {
      operands++;
      rpn[rpnLength++] = node;
      node.augmented = isExpectingOperand = false;
    }

    if (stackPop || stackOutput) {
      isSeparator = node.isSeparator || false;
      precedence = node.precedence;

      for (; stack; stack = stack[0]) {
        item = stack[1];
        isEnder = item.ender;

        if (!isEnder &amp;&amp; item.precedence &gt;= precedence) {
          expectedOperands = item.operands += operands;
          operands = 1;
          max = item.max;

          if (expectedOperands &lt; item.min ||
            (max &amp;&amp; max &gt; expectedOperands)
          ) {
            report(INVALID_OPERAND_TOKEN, item, subject);
            return null;
          }

          if (item.rule) {
            rpn[rpnLength++] = item;
          }
          continue;
        }

        if (isSeparator &amp;&amp; item.separator) {
          item.operands += operands;
          operands = 1;
        }
        else if (stackOutput) {
          item.operands += operands;

          // postfix ender
          if (isEnder &amp;&amp; item.precedence) {
            item.ender = false;
            operands = 0;
          }
          else {
            expectedOperands = item.operands;
            max = item.max;

            if (expectedOperands &lt; item.min ||
              (max &amp;&amp; max &gt; expectedOperands)
            ) {
              report(INVALID_OPERAND_TOKEN, item, subject);
              return null;
            }

            if (item.rule) {
              rpn[rpnLength++] = item;
            }
            stack = stack[0];
          }
        }
        break;
      }
    }

    if (stackPush) {
      if (node.requiredLeftOperands !== operands) {
        report(INVALID_OPERAND_TOKEN, node, subject);
        return null;
      }
      node.operands += operands;
      operands = 0;
      stack = [stack, node];
    }
  }

  return rpn;
}
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(1.1.0)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
