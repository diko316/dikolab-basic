<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../">
  <title data-ice="title">src/json/parser.js | @dikotech/basic</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  <script src="script/manual.js"></script>
<meta name="description" content="Basic Javascript helpers"><meta property="twitter:card" content="summary"><meta property="twitter:title" content="@dikotech/basic"><meta property="twitter:description" content="Basic Javascript helpers"></head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
<a style="position:relative; top:3px;" href="https://github.com/diko316/dikotech-basic"><img width="20px" src="./image/github.png"></a></header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#array">array</a><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-listPadEnd">listPadEnd</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-listPadStart">listPadStart</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-Iteratable">Iteratable</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-IteratableObject">IteratableObject</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#json">json</a><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-compile">compile</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-query">query</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-updateMaxCompiled">updateMaxCompiled</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-exec">exec</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#lifecycle">lifecycle</a><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-destructor">destructor</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#native">native</a><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-array">array</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-bigint">bigint</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-boolean">boolean</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-date">date</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-iteratable">iteratable</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-method">method</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-number">number</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-numeric">numeric</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-object">object</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-promise">promise</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-regexp">regexp</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-scalar">scalar</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-signature">signature</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-string">string</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-symbol">symbol</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#number">number</a><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-numberify">numberify</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#object">object</a><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-assign">assign</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-each">each</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-contains">contains</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#string">string</a><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-padEnd">padEnd</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-padStart">padStart</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-quoteEscape">quoteEscape</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-repeat">repeat</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-trim">trim</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-trimEnd">trimEnd</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-trimStart">trimStart</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-stringify">stringify</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#unicode">unicode</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/unicode/Utf.js~Utf.html">Utf</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-codepoints2Utf">codepoints2Utf</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-unicodeCount">unicodeCount</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-unicodify">unicodify</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-codePoint2string">codePoint2string</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-eachUnicode">eachUnicode</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-string2codePoints">string2codePoints</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-string2unicodes">string2unicodes</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">src/json/parser.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">
import { tokenize } from &quot;./tokenizer&quot;;

import { reportParseError } from &quot;./error-reporting&quot;;

import * as PARSER_STATES from &quot;./parse-states.json&quot;;
import * as PARSER_REFERENCE from &quot;./parse-reference.json&quot;;

const ACTION_TOKENIZE = 1;
const ACTION_REDUCE = 2;
const ACTION_FOLLOW = 3;
const ACTION_END = 4;
const IGNORE_TOKENS = {};

function initialize() {
  const index = IGNORE_TOKENS;
  const list = PARSER_REFERENCE.ignoreTokens;
  let c = 0;
  let length = list.length;

  // ignore tokens
  for (; length--; c++) {
    index[list[c]] = true;
  }
}

initialize();

/**
 * RPN (Reverse Polish Notation) struct.
 *
 * @ignore
 * @protected
 * @typedef {object} RpnItem
 * @property {string} ruleId - Terminal token name or production name if non-terminal.
 * @property {string|null} value - The raw token from tokenize process. null for reduced non-terminal.
 * @property {number} reduce - The total number of rpn to merge. zero if terminal or token.
 * @property {number} from - The start character index of code parsed.
 * @property {number} to - The end character index of code parsed.
 * @property {number} lineFrom - The start line number of code parsed.
 * @property {number} lineTo - The end line number of code parsed.
 */

/**
 * List of RPN (Reverse Polish Notation) items.
 *
 * @ignore
 * @protected
 * @typedef {RpnItem[]} Rpn
 */

/**
 * Parse JSON Query code and returns list of reverse polish notation (RPN) list.
 *
 * @ignore
 * @protected
 * @param {string} subject - The code to parse.
 * @returns {Rpn|null} - RPN list as abstract tree. Returns null if parse failed.
 */
export function parse(subject) {
  const tokenizeAction = ACTION_TOKENIZE;
  const reduceAction = ACTION_REDUCE;
  const followAction = ACTION_FOLLOW;
  const endAction = ACTION_END;
  const manifest = PARSER_STATES;
  const ignoreTokens = IGNORE_TOKENS;

  const states = manifest.states;
  const ends = manifest.reduce;
  const root = manifest.root;
  const rpn = [];

  let stateAccess = manifest.initialState;
  let state = states[stateAccess];
  let end;
  let action = tokenizeAction;

  let parseStack = null;
  let inStack = null;
  let index = 0;
  let found;
  let token;
  let value;
  let from;
  let to;
  let production;
  let rule;
  let input;
  let length;
  let total;
  let rpnFrom;
  let rpnTo;
  let erroneous = false;
  let lineBefore = 1;
  let lines = 1;
  let rpnIndex = 0;

  /* eslint no-labels:0 */
  mainLoop: for (; action !== endAction;) {
    switch (action) {
    case tokenizeAction:
      found = tokenize(subject, index);
      if (found) {
        token = found[0];
        from = index;
        to = found[2];
        index = to;
        lineBefore = lines;
        lines += found[3];

        // tokenize again
        if (token in ignoreTokens) {
          action = tokenizeAction;
          continue mainLoop;
        }

        // for RPN
        value = found[1];

        // follow
        action = endAction;
        if (token in state) {
          action = followAction;
        }
        // try reducing
        else if (stateAccess in ends) {
          action = reduceAction;
        }
        // failed token
        else {
          erroneous = true;
          reportParseError(
            &quot;Syntax error&quot;,
            subject,
            from,
            to,
            lineBefore,
            lines
          );
          break mainLoop;
        }
      }
      // reduce to root
      else if (parseStack &amp;&amp; stateAccess in ends) {
        action = reduceAction;
      }
      // parse failed!
      else {
        erroneous = true;
        reportParseError(
          &quot;Syntax error&quot;,
          subject,
          from,
          to,
          lineBefore,
          lines
        );
        break mainLoop;
      }
      continue mainLoop;

    case followAction:
      token = found[0];

      inStack = [
        stateAccess,
        token
      ];
      // console.log(&quot;follow! &quot;, stateAccess, token, &quot; -&gt; &quot;, state[token], &quot;:&quot;, value);
      stateAccess = state[token];
      state = states[stateAccess];
      parseStack = [
        parseStack,
        inStack,
        rpnIndex
      ];

      // add to rpn
      rpn[rpnIndex++] = {
        ruleId: token,
        reduce: 0,
        from,
        to,
        lineFrom: lineBefore,
        lineTo: lines,
        value
      };

      // tokenize
      action = tokenizeAction;
      continue mainLoop;

    case reduceAction:
      // console.log(&quot;reducing &quot;, stateAccess, ends[stateAccess]);
      end = ends[stateAccess];
      rule = end[0];
      length = total = end[1];
      production = end[2];
      rpnTo = null;

      for (; parseStack &amp;&amp; length--;) {
        inStack = parseStack[1];
        input = inStack[1];
        rpnFrom = rpn[parseStack[2]];

        if (!rpnTo) {
          rpnTo = rpn[parseStack[2]];
        }

        if (input !== production[length]) {
          erroneous = true;
          reportParseError(
            `Syntax error of ${input}`,
            subject,
            rpnFrom.from,
            rpnTo.to,
            rpnFrom.lineFrom,
            rpnTo.lineTo
          );
          break mainLoop;
        }

        // resume, reduce did not end yet
        if (length !== 0) {
          parseStack = parseStack[0];
          continue;
        }

        // reduce successfull
        // add to rpn
        rpn[rpnIndex++] = {
          ruleId: end[3],
          reduce: total,
          from: rpnFrom.from,
          to: rpnTo.to,
          lineFrom: rpnFrom.lineFrom,
          lineTo: rpnTo.lineTo,
          value: null
        };

        stateAccess = inStack[0];
        state = states[stateAccess];

        // console.log(&quot;reduced! &quot;, stateAccess, rule, &quot;: &quot;, production, &quot; pending &quot;, token, &quot;=&quot;, value);

        // follow new state
        if (rule in state) {
          parseStack = [
            parseStack[0],
            [
              stateAccess,
              rule
            ],
            rpnIndex - 1
          ];
          stateAccess = state[rule];
          state = states[stateAccess];
        }
        // parse complete!
        else if (rule === root) {
          break mainLoop;
        }
        // unable to follow reduced state
        else {
          erroneous = true;
          reportParseError(
            `Syntax error in sequence ${rule}`,
            subject,
            rpnFrom.from,
            rpnTo.to,
            rpnFrom.lineFrom,
            rpnTo.lineTo
          );
          break mainLoop;
        }
      }

      // check if it should reduce back
      action = reduceAction;

      // or follow
      if (token &amp;&amp; token in state) {
        action = followAction;
      }
      else if (!(stateAccess in ends)) {
        erroneous = true;
        if (token) {
          reportParseError(
            `Syntax error misplaced token: ${token}`,
            subject,
            from,
            to,
            lineBefore,
            lines
          );
        }
        else {
          reportParseError(
            &quot;Syntax error&quot;,
            subject,
            from,
            to,
            lines,
            lines
          );
        }
        break mainLoop;
      }

      continue mainLoop;
    }
  }

  // console.log(&quot;partial &quot;, JSON.stringify(rpn, null, 3));
  if (erroneous &amp;&amp; rpn.length) {
    console.log(
      &quot;last partial rpn: &quot;,
      JSON.stringify(
        rpn.slice(
          Math.max(rpn.length - 5, 0),
          rpn.length
        ),
        null,
        3
      )
    );
  }

  return erroneous ? null : rpn;
}
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(1.1.0)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
